{"version":3,"file":"osana.worker.js","mappings":"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","sources":["webpack://osana/./src/lib/util/worker.ts"],"sourcesContent":["var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\r\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n};\r\nimportScripts(`./osana.bundle.js?1`);\r\nimportScripts(`./osana.config.js?1`);\r\nself.OsanaServiceWorker = class OsanaServiceWorker {\r\n    constructor() {\r\n        this.config = self.__osana$config;\r\n        this.bundle = self.__osana$bundle;\r\n        this.bareClient = new this.bundle.BareClient(this.config.bare);\r\n    }\r\n    fetch(event) {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            const url = this.config.codec.decode(new URL(event.request.url).pathname.replace(this.config.prefix, \"\")) + new URL(event.request.url).search;\r\n            if (!/^https?:\\/\\//.test(url)) {\r\n                return fetch(event.request.url);\r\n            }\r\n            const requestURL = new URL(url);\r\n            const requestHeaders = this.bundle.rewrite.headers.request(Object.fromEntries(event.request.headers.entries()), requestURL);\r\n            if (this.config.blacklist && this.config.blacklist.some(regex => regex.test(requestURL.host))) {\r\n                return new BlackListedResponse();\r\n            }\r\n            const bareRequestData = {\r\n                method: event.request.method,\r\n                headers: requestHeaders\r\n            };\r\n            if (![\"GET\", \"HEAD\"].includes(event.request.method))\r\n                bareRequestData.body = yield event.request.blob();\r\n            const response = yield this.bareClient.fetch(requestURL, bareRequestData);\r\n            let responseStatus = response.rawResponse.status;\r\n            const responseHeaders = this.bundle.rewrite.headers.response(response.rawHeaders, requestURL);\r\n            let responseData = \"\";\r\n            if (/text\\/html/.test(responseHeaders[\"Content-Type\"])) {\r\n                responseData =\r\n                    `<head>` +\r\n                        `<script src=\"${this.config.files.bundle}?1\"></script>` +\r\n                        `<script src=\"${this.config.files.config}?1\"></script>` +\r\n                        `<script src=\"${this.config.files.client}?1\"></script>` +\r\n                        `<link rel=\"icon\" href=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAA1JREFUGFdjYGBkZAAAAAoAAx9k7/gAAAAASUVORK5CYIIA\">` +\r\n                        `<link rel=\"icon\" href=\"${requestURL.origin}/favicon.ico\">` +\r\n                        `${(responseStatus === 301 && responseHeaders[\"location\"]) ? `<meta http-equiv=\"refresh\" content=\"0; url=${this.bundle.rewrite.url(responseHeaders[\"location\"])}\">` : \"\"}` +\r\n                        `</head>`;\r\n                responseData += this.bundle.rewrite.html(yield response.text(), (requestURL.origin + requestURL.pathname));\r\n            }\r\n            else if (/text\\/css/.test(responseHeaders[\"Content-Type\"]) || event.request.destination === \"style\") {\r\n                responseData = this.bundle.rewrite.css(yield response.text(), (requestURL.origin + requestURL.pathname));\r\n            }\r\n            else if (/application\\/javascript/.test(responseHeaders[\"Content-Type\"]) || event.request.destination === \"script\") {\r\n                responseData = this.bundle.rewrite.js(yield response.text());\r\n            }\r\n            else {\r\n                responseData = yield response.arrayBuffer();\r\n            }\r\n            return new Response(responseData, {\r\n                status: response.rawResponse.status,\r\n                statusText: response.rawResponse.statusText,\r\n                headers: responseHeaders\r\n            });\r\n        });\r\n    }\r\n};\r\nclass BlackListedResponse extends Response {\r\n    constructor() {\r\n        super(\"Forbidden\", {\r\n            status: 403,\r\n            statusText: \"Forbidden\",\r\n            headers: {\r\n                \"Content-Type\": \"text/plain\"\r\n            }\r\n        });\r\n    }\r\n}\r\nexport {};\r\n"],"names":["importScripts","self","OsanaServiceWorker","constructor","this","config","__osana$config","bundle","__osana$bundle","bareClient","BareClient","bare","fetch","event","thisArg","_arguments","generator","url","codec","decode","URL","request","pathname","replace","prefix","search","test","requestURL","requestHeaders","rewrite","headers","Object","fromEntries","entries","blacklist","some","regex","host","BlackListedResponse","bareRequestData","method","includes","body","blob","response","responseStatus","rawResponse","status","responseHeaders","rawHeaders","responseData","files","client","origin","html","text","destination","css","js","arrayBuffer","Response","statusText","P","Promise","resolve","reject","fulfilled","value","step","next","e","rejected","result","done","then","apply","super"],"sourceRoot":""}